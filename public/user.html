<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>æ¼«æ¼«æµå®  Â· æˆ‘çš„é¢†å…»</title>
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI","PingFang SC",Arial,sans-serif;
      background: linear-gradient(135deg,#fff1eb,#ace0f9);
      padding: 30px;
    }

    .top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 26px;
    }

    .title-box h1 {
      margin: 0;
      font-size: 26px;
    }

    .title-box p {
      margin-top: 6px;
      font-size: 14px;
      color: #666;
    }

    .nav a {
      margin-left: 16px;
      font-size: 14px;
      text-decoration: none;
      color: #333;
    }

    h2 {
      margin: 28px 0 16px;
      font-size: 20px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px,1fr));
      gap: 18px;
    }

    .card {
      background: #fff;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 8px 18px rgba(0,0,0,.15);
    }

    .meta {
      margin-top: 6px;
      font-size: 14px;
      color: #555;
    }

    .tag {
      margin-top: 10px;
      font-size: 13px;
      padding: 4px 12px;
      border-radius: 12px;
      width: fit-content;
      color: #fff;
    }

    .published { background:#4caf50; }
    .submitted { background:#9e9e9e; }
    .approved { background:#43a047; }
    .rejected { background:#e53935; }

    button {
      margin-top: 14px;
      padding: 8px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      background: #ff7a7a;
      color: #fff;
      font-size: 14px;
    }

    .empty {
      color: #666;
      font-size: 14px;
    }
  </style>
</head>

<body>

<div class="top">
  <div class="title-box">
    <h1>ğŸ¾ æˆ‘çš„é¢†å…»</h1>
    <p id="who"></p>
  </div>
  <div class="nav">
    <a href="/index.html">è¿”å›é¦–é¡µ</a>
    <a href="/revenue.html">ç›ˆåˆ©ä¸­å¿ƒ</a>
  </div>
</div>

<h2>å¯é¢†å…»åŠ¨ç‰©</h2>
<div id="animalList" class="grid"></div>

<h2>æˆ‘çš„é¢†å…»ç”³è¯·</h2>
<div id="myApplications" class="grid"></div>

<script>
  function statusText(status) {
    if (status === 'submitted') return 'å·²æäº¤ï¼Œç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸';
    if (status === 'approved') return 'å®¡æ ¸é€šè¿‡ï¼Œå¯åŠç†é¢†å…»æ‰‹ç»­';
    if (status === 'rejected') return 'å®¡æ ¸æœªé€šè¿‡';
    return status;
  }

  async function loadMe() {
    const res = await fetch('/api/auth/me');
    const data = await res.json();
    document.getElementById('who').textContent =
      data.user ? `å½“å‰ç™»å½•ï¼š${data.user.username}` : 'æœªç™»å½•';
  }

  async function applyAdoption(animalId) {
    const contact = prompt("è¯·è¾“å…¥è”ç³»æ–¹å¼ï¼ˆç”µè¯/å¾®ä¿¡ï¼‰ï¼š");
    if (!contact) return;
    const reason = prompt("ç®€å•è¯´æ˜é¢†å…»åŸå› ï¼ˆå¯é€‰ï¼‰ï¼š") || "";

    const res = await fetch('/api/adoptions/apply', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ animal_id:animalId, contact, reason })
    });

    const data = await res.json();
    if (res.ok) {
      alert("é¢†å…»ç”³è¯·å·²æäº¤ï¼Œè¯·ç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸");
      loadApplications();
    } else {
      alert(data.error || "æäº¤å¤±è´¥");
    }
  }

  async function loadAnimals() {
    const box = document.getElementById('animalList');
    box.innerHTML = '';

    const res = await fetch('/api/animals');
    const animals = await res.json();

    const published = animals.filter(a => a.status === 'published');
    if (!published.length) {
      box.innerHTML = `<div class="empty">æš‚æ— å¯é¢†å…»åŠ¨ç‰©</div>`;
      return;
    }

    published.forEach(a => {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <h3>${a.name}</h3>
        <div class="meta">ç§ç±»ï¼š${a.species}</div>
        <div class="tag published">å¯é¢†å…»</div>
        <button onclick="showAnimalDetail(${a.id})">æŸ¥çœ‹è¯¦æƒ…</button>
        <button onclick="applyAdoption(${a.id})">ç”³è¯·é¢†å…»</button>
      `;
      box.appendChild(card);
    });
  }

  async function loadApplications() {
    const box = document.getElementById('myApplications');
    box.innerHTML = '';

    const res = await fetch('/api/adoptions/my');
    const apps = await res.json();

    if (!apps.length) {
      box.innerHTML = `<div class="empty">æš‚æ— é¢†å…»ç”³è¯·è®°å½•</div>`;
      return;
    }

    apps.forEach(a => {
      const card = document.createElement('div');
      card.className = 'card';

      card.innerHTML = `
        <h3>${a.animal_name}</h3>
        <div class="meta">${statusText(a.status)}</div>
        <div class="tag ${a.status}">${a.status}</div>
      `;
      box.appendChild(card);
    });
  }

  loadMe();
  loadAnimals();
  loadApplications();

  async function showAnimalDetail(animalId) {
    const res = await fetch(`/api/animals/${animalId}`);
    const data = await res.json();

    const a = data.animal;
    const h = data.health;

    const text = `
  åŠ¨ç‰©åç§°ï¼š${a.name}
  ç§ç±»ï¼š${a.species}
  æ€§åˆ«ï¼š${a.sex || 'æœªçŸ¥'}
  å¹´é¾„ï¼š${a.age || 'æœªçŸ¥'}
  å‘ç°åœ°ç‚¹ï¼š${a.location || 'æœªçŸ¥'}

  å¥åº·æƒ…å†µï¼š
  ç–«è‹—æ¥ç§ï¼š${h.vaccinated ? 'å·²æ¥ç§' : 'æœªæ¥ç§'}
  ç»è‚²æƒ…å†µï¼š${h.neutered ? 'å·²ç»è‚²' : 'æœªç»è‚²'}
  é©±è™«æƒ…å†µï¼š${h.dewormed ? 'å·²é©±è™«' : 'æœªé©±è™«'}
  å¤‡æ³¨ï¼š${h.notes || 'æ— '}
  `;

    alert(text);
}

</script>

</body>
</html>
