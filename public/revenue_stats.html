<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>ç›ˆåˆ©ç»Ÿè®¡ï¼ˆç®¡ç†å‘˜ï¼‰</title>
  <style>
    body{font-family:Arial;background:#f5f7fa;padding:30px}
    .card{background:#fff;border-radius:14px;padding:18px;box-shadow:0 6px 14px rgba(0,0,0,.12);margin-top:18px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #ddd;padding:8px;font-size:14px}
    th{background:#fafafa}
    .ok{color:green;font-weight:bold}
    .err{color:#c00;font-weight:bold}
    a{color:#333;text-decoration:none;margin-right:12px}
  </style>
</head>
<body>

<h1>ğŸ“Š ç›ˆåˆ©ç»Ÿè®¡ï¼ˆä»…ç®¡ç†å‘˜ï¼‰</h1>
<div>
  <a href="/revenue.html">è¿”å›ç›ˆåˆ©ä¸­å¿ƒ</a>
  <a href="/admin.html">è¿”å›ç®¡ç†å‘˜ç«¯</a>
</div>

<div id="gate" class="card">æƒé™æ ¡éªŒä¸­...</div>

<div id="content" style="display:none;">
  <div class="card" id="summary"></div>

  <div class="card">
    <h2>å…¨ç«™è®¢å•æ˜ç»†</h2>
    <table>
      <thead>
        <tr>
          <th>è®¢å•ID</th><th>ç”¨æˆ·ID</th><th>ç±»å‹</th><th>å•†å“</th><th>é‡‘é¢</th><th>æ—¶é—´</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>
</div>

<script>
function sumByType(orders){
  const m = {};
  for(const o of orders){
    m[o.service_type] = (m[o.service_type] || 0) + Number(o.amount || 0);
  }
  return m;
}

async function main(){
  const me = await (await fetch('/api/auth/me')).json();
  const gate = document.getElementById('gate');

  if(!me.user){
    gate.innerHTML = `<span class="err">æœªç™»å½•ï¼Œæ— æ³•æŸ¥çœ‹ç»Ÿè®¡ã€‚è¯·å…ˆå» login.html ç™»å½• adminã€‚</span>`;
    return;
  }
  if(me.user.role !== 'admin'){
    gate.innerHTML = `<span class="err">æ— æƒé™ï¼šå½“å‰è§’è‰²ä¸º ${me.user.role}ï¼Œä»…ç®¡ç†å‘˜å¯æŸ¥çœ‹ç›ˆåˆ©ç»Ÿè®¡ã€‚</span>`;
    return;
  }

  gate.innerHTML = `<span class="ok">æƒé™é€šè¿‡ï¼š${me.user.username}ï¼ˆadminï¼‰</span>`;
  document.getElementById('content').style.display = 'block';

  const r = await fetch('/api/admin/orders');
  const orders = await r.json();

  const totals = sumByType(orders);
  const totalAll = Object.values(totals).reduce((a,b)=>a+b,0);

  const summary = document.getElementById('summary');
  summary.innerHTML = `
    <h2>æ”¶å…¥æ±‡æ€»</h2>
    <div>æ€»æ”¶å…¥ï¼š<b>ï¿¥${totalAll.toFixed(2)}</b></div>
    <div style="margin-top:8px;">
      ç–«è‹—ï¼šï¿¥${(totals.vaccine||0).toFixed(2)} ï½œ é£Ÿç²®ï¼šï¿¥${(totals.food||0).toFixed(2)}
      ï½œ ä¿é™©ï¼šï¿¥${(totals.insurance||0).toFixed(2)} ï½œ æåŠ©ï¼šï¿¥${(totals.donation||0).toFixed(2)}
    </div>
  `;

  const tbody = document.getElementById('rows');
  tbody.innerHTML = '';
  orders.forEach(o=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${o.id}</td><td>${o.user_id}</td><td>${o.service_type}</td><td>${o.product_name}</td><td>${o.amount}</td><td>${o.created_at}</td>`;
    tbody.appendChild(tr);
  });
}
main();
</script>
</body>
</html>
